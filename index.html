<!DOCTYPE html>
<html>
    <head>
        <title> 爬虫.remark </title>
	<meta name="marboo-template" content="remark.md.html">
        <meta name="viewport" content="width=320, initial-scale=1.0, user-scalable=yes" charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="generator" content="Marboo 1.0: http://marboo.io" />
        <meta name="date" content="2013-03-23 13:21:17" />
	<meta name="keywords" content="Marboo" />

        <link rel="stylesheet" type="text/css" href="/.media/packages/markdown/remark.js/remark.css" />
        <link rel="stylesheet" type="text/css" href="/.media/css/marboo.css" media="screen" />
    </head>
    <body style="background-color:transparent">
        <!--
            # This file is created from $MARBOO_HOME/.media/starts/default.html
            # 本文件由 $MARBOO_HOME/.media/starts/default.html 复制而来
        -->
        <textarea id="source" style="display:none">class: center, middle
# 爬虫技术分享

by shiqi

4月13日



---
## 0. 为什么需要爬虫？


我们想要尽量低成本的、自动化地抓取网页上有价值的信息

而且这些信息，通常数量还很多，或者手动抓取费时麻烦

所以我们的目标是：

> 动手实现一个简易的爬虫程序  


---
## 1. 从例子开始

比如我想一口气导出《生活大爆炸》全季的下载链接，

http://www.zimuzu.tv/resource/list/11005 

手动点有点 low，可以怎么做呢？
--

#### 更 Geek 一点的做法
--

用 chrome 浏览器打开资源页面，右键"审查元素",
   
可以发现，在 html 文本中所有磁力链接的格式是相似的

``` 
<a href="magnet:XXXXXXXXXXXXXXXXX" type="magnet" target="_blank">磁力</a>
```

那我可以直接在 html 文件中把这些链接找出来


---

那么如何在搜索时准确描述，找到全部的链接呢？

一个方便的工具，是使用正则表达式.red.bold[*]


``` 
(?>=<a href=")(magnet.*)(?=" type="magnet">) 
```

这条正则表达式的讲解在下一页，不想看的可以略过


.footnote[.red.bold[*] 关于正则表达式的介绍 http://www.regexlab.com/zh/regref.htm]

---


```

               匹配引号内容
               而且以 magnet 开头
                    |
                    v  
```
```
    (?>=<a href=")(magnet.*)(?=" type="magnet") 
```
```
         ^                         ^
         |                         |
    匹配前缀 <a href="             |
                            匹配后缀 " type="magnet"

```

---

## 2. 用 Python 实现

再升级一点，写个 python 脚本

``` python
import urllib
import re
from bs4 import BeautifulSoup

url = "http://www.zimuzu.tv/resource/list/11005"
response = urllib.urlopen(url)
html = response.read()
soup = BeautifulSoup(html)

tags = soup.findAll(name = "a", attrs={'href':re.compile("^magnet:")})

for i in range(len(tags)):
    print tags["href"]

```

实际运行的时候，会发现需要进入登陆页面，才会显示资源

可以先用 python 模拟登陆，并保存 cookies，然后就能访问了。  

那如何登陆呢，也不难，需要查看网站源码

---

``` html
<script>
$("#login").click(function(){
  GLOBAL.Loading();
  $('#login').attr('disabled',true);
  var email = $("input[name=email]").val();
  var password = $("input[name=password]").val();
  var remember = ($("input[name=remember]").attr("checked") == 'checked') ? 1 : 0;
  var url_back = '';
  $.post('http://www.zimuzu.tv/User/Login/ajaxLogin',
  {account:email,password:password,remember:remember,url_back:url_back},function(R){
    GLOBAL.Loading('hide');

    ...
```
注意 `$.post` 这一行，说明我们需要先向`http://www.zimuzu.tv/User/Login/ajaxLogin`页面发送如下登陆数据

```
  { 
    account:email,
    password:password,
    remember:remember,
    url_back:url_back
  }
```


---

## 3. 完整的 Python 实现
``` python
import urllib
import urllib2
import cookielib

cookie = cookielib.CookieJar()  
opener = urllib2.build_opener(urllib2.HTTPCookieProcessor(cookie))  

values={}
values['account'] = "XXXX"
values['password'] = "XXXX"
values['remember'] = ''
values['url_back'] = ''
postdata = urllib.urlencode(values) 
request = urllib2.Request("http://www.zimuzu.tv/User/Login/ajaxLogin", postdata)
response = opener.open(request)

print response.read()
```

如果返回

`{"status":1,"info":"\u767b\u5f55\u6210\u529f\uff01","data":{"url_back":"http:\/\/www.zimuzu.tv\/user\/user\/"}}`

就说明登陆成功了

---

接着再运行

``` python
from bs4 import BeautifulSoup
import re

url = "http://www.zimuzu.tv/resource/list/11005"
response = opener.open(url)
html = response.read()
soup = BeautifulSoup(html)

tags = soup.findAll(name = "a", attrs={'href':re.compile("^magnet:")})

for i in range(len(tags)):
    print tags["href"]
```

就可以了

---

## 4. 更多衍生内容

没有提到的内容: 1. 动态网页  2. 如何爬整站 3. 反爬虫
以及更多。。。


推荐的资料：

* [Python爬虫开发（1）](http://www.freebuf.com/news/special/96763.html)
* [Python爬虫开发（2）](http://www.freebuf.com/news/special/96821.html)</textarea>
        <script src="/.media/packages/markdown/remark.js/remark-0.6.5.min.js" type="text/javascript"></script>
	<script type="text/javascript">
	  var hljs = remark.highlighter.engine;
	</script>
	<script src="/.media/packages/markdown/remark.js/remark.language.js" type="text/javascript"></script>
	<script type="text/javascript">
	  var slideshow = remark.create({
          highlightStyle: 'monokai',
          highlightLanguage: 'remark'
          }) ;
	</script>
    </body>
</html>
